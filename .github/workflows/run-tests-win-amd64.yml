name: run-tests-win-amd64
on: 
  push: 
jobs:
  run_tests:
    name: Runs tests on ${{ matrix.os }}-cp${{ matrix.python }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
        python: ["3.9", "3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "pybind11[global]"
          
      - name: Compile aten
        shell: pwsh
        run: |
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Directory contents:"
          Get-ChildItem
          
          Write-Host "Python version:"
          python --version
          
          Write-Host "Pip version:"
          pip --version
          
          $env:CMAKE_DEV = 1
          pip install . -vvv
          
      - name: Find and Run CPP tests
        shell: pwsh
        run: |
          $testPaths = @(
            ".\build\test\Debug\tests.exe",
            ".\build\test\Release\tests.exe",
            ".\build\test\tests.exe"
          )
          
          $testPath = $null
          foreach ($path in $testPaths) {
            if (Test-Path $path) {
              $testPath = $path
              break
            }
          }
          
          if ($testPath) {
            Write-Host "Found test executable at: $testPath"
            & $testPath
          } else {
            Write-Host "Test executable not found. Directory contents:"
            Get-ChildItem -Recurse .\build\test
            exit 1
          }
          
      - name: Run Python tests 
        run: | 
          python test/GradTensor/algebra_test.py
          python test/GradTensor/constructor_test.py
          python test/GradTensor/util_test.py
          python test/Tensor/algebra_test.py
          python test/Tensor/constructor_test.py
          python test/Tensor/util_test.py
